站点需要通过网络来响应用户的请求,站点内部也需要通过网络来组建分布式环境.  
### 2.1 分层网络模型  
 普遍采用OSI七层网络模型或TCP四层网络模型,这里不做详细介绍.  
 物理层——数据链路层——网络层——传输层——会话层——表示层——应用层  
 我们希望探讨网络模型中一些细节的本质和实现,尤其是数据传输比较低层的实现,包括分组交换,流量控制,数据转发等.  
##### 物理层的线路(类似于铁路)  
 为互相通信的主机建立物理连接,提供信号传输介质.  
##### 网络中的节点(类似于火车站)  
 如:计算机,路由器等,通过**节点的网络接口**(比如计算机的网卡),内部数据总线与网络物理层线路间接连接.网络接口负责将节点内部总线中的字节数和线路中传输的二进制信号进行相互转换.  
##### 节点物理地址(类似于火车站地址)  
 即:MAC地址,它由设备生产厂家唯一确定.通过现代电路技术,线路中的数据信号可以很容易传输到指定MAC地址的节点.  
##### 数据链路层的传输帧(类似于火车)  
 它包括头部信息和数据区,头部信息指明了目的地节点的MAC地址.  
##### 总线网络拓扑结构(类似于火车站串联方式)  
 缺点:数据传输采用广播方式,所以所有主机共享网络带宽,在这种情况下,由于线路过长会使信号衰减,所以不能无休止地通过中继器延长总线来增加网络节点,限制了网络的扩展.  
##### 星型网络拓扑结构(类似于火车站调度站方式)  
 使用额外的中间节点来交换数据,且中央节点负担较重,但是这种方式控制方便,易于扩展.星型网络的带宽是否共享是由中央节点的处理方式决定的,常见的有集线器和交换机.  
##### 早起的集线器(类似于普通调度站)  
 通过简单的集成电路实现了星型拓扑网络结构.但由于其值工作在物理层,所以对于来自某一主机的数据帧并不知道它的目的地是哪里,也就是无法识别MAC地址,所以不加判断地直接将数据帧转发到所有其它端口连接的主机.它的本质和总线网络相同,都是广播方式的数据转发,需要有数据帧碰撞检测机制,所有主机共享整个网络的带宽,容易相互影响.  
##### 交换机(类似于高级调度站)  
 它拥有独立的处理器和高速缓存,对数据采用存储转发方式,并且使用更加先进的电路设计,可以对数据帧根据MAC地质进行准确转发,抛弃了传统的广播方式,这就使得网络中的主机通信不会互相影响,大家都可以独享网络带宽.  
##### 电路交换方式(类似于预约线路)  
 计算机通信的需求非常复杂,数据传输突发性强,数据量变化频繁,数据可靠性需要保证,传输速度需要不断提高,所以人们觉得电路交换方式无法满足需求,在当时便设计出了**分组交换方式**,即将数据分成若干小块,称为数据帧,分时依次发送.  
##### 数据链路层的流量控制(类似于火车站车流控制)  
 数据链路层作为控制数据帧传输的底层,必须保证到达目的地主机网卡的数据帧可以交付给上层应用,这个交付工作具体来说,就是网卡把接收到的二进制信号转换为字节,然后写入由操作系统内核在内存中拥有的一块高速缓存区,同时通过中断切换到相应的应用程序进程并取走这些数据.有很多原因可以导致这块缓存区某时刻被写满,比如同时下载多个文件使得写入速率超过取走速率,这时候如果数据帧的发送端不减慢发送速率,
 则很多数据帧到达后,网卡会因为缓存区已满而丢弃这些数据,因为网卡对此确实无能无力.这就需要在数据链路层存在一种流量控制机制,实际方法一般采用窗口滑动技术.  
##### 数据链路层的差错控制和选择重发.(类似于火车站货物损坏自动重发)  
 事实上,我们使用的以太网,由于线路质量非常好,数据链路层已经不做差错校验和自动转发,而是将校验及重发控制权更上层的协议,比如TCP.而对于802.11x等无线网络以及卫星通信领域,数据链路层还是需要进行大量的数据可靠性校验规则工作.  
##### 局域网(类似于城市)  
 相当于拥有同一个广播域的网络.  
##### 局域网的广播地址(类似于城市广播站)  
 发往这个地址的数据帧会被发送到局域网内所有的节点.  
##### 节点网络接口的IP地址(类似于火车站名称)  
 由用户自行设置或者通过DHCP获得.  
##### 网卡IP地址到MAC地址的转换(类似于火车站地址的转换)  
 因为数据帧在网络中传输时,只可以通过目的地MAC地址来寻址,所以必须将目的地IP地址转换为MAC地址并告知数据帧.具体地转换方式是:数据发送端ARP协议发送广播到局域网内所有的主机,询问大家谁拥有指定的IP地址,如果拥有的话就请告知自己的MAC地址.  
##### ARP绑定(类似于火车站地址关系绑定)  
 将局域网内某其他主机网卡的MAC地址和IP地址的对于关系写入ARP表,也称为"ARP"绑定.对于绑定后的目标主机,任何时候发送数据都不需要进行广播询问,而是直接从ARP表中寻找对应关系即可.  
##### 路由器(类似于城市中转站)  
 工作在网络层,可以识别数据帧中携带的目的地IP地址,并将其转发至正确的网络.  
##### 互联网(类似于城市互联)  
 很多网络通过路由器连接,形成互联网.  
##### 网络层的数据包(类似于货物包)  
 它的头部信息包含了IP地址,主要用于数据帧的寻址.  
##### 建立通信的两个主机上运行的进程(类似于发货人和收货人)  
 这些进程的网络端口号类似于发货人和收货人的详细信息.  
##### 传输层的数据包(类似于传输包)  
 包括头部信息和正文,在头部信息中指明了用端口号来代表的进程,它们实现了真正意义上的两个主机进程之间的网络通信,而很好地屏蔽了底层的传输细节.
 常见的传输层协议包括TCP和UDP,这些协议具有流量控制,流量限制和错误重发等控制机制.  
##### 应用层的各种数据包(类似于礼品包,订购包,产品包)  
 它们根据应用程序之间的协议约定,对数据进行再次封装,包括头部信息和正文,比如HTTP,FTP,SSH等.  
### 2.2 带宽  
 单位:bit/s,即时间单位的比特数.  
 将带宽解释为数据在线路中的传输速度这种表述严格上来说并不准确.  
 这里我们关心的是带宽与高性能Web站点相关的一些必要知识.所以要深入了解数字网络通信领域的带宽概念,实际上它已经超出了通信的范畴,我们需回到计算机体系结构中来理解带宽,因为带宽的发源地之一是计算机系统总线.  
##### 数据如何发送  
 数据的发送(即数据从主机进入线路的这段旅程),一般需要经过一下几个环节:  

 1. 程序首先得将要发送的数据写入该进程的内存地址空间中,通常在程序开发中这只需要一般的运行时变量赋值.  
 2. 应用程序通过系统函数库接口(比如send函数)向内核发出系统调用,由**系统内核**进行随后的操作,它将这些数据从**用户态内存区**复制到由内核维护的一段称为**内核缓冲区**的内存地址空间.这块地址空间的大小通常是有限的,所以要发送的数据将以**队列**的形式进入这里,这些数据可能来自于**多个进程**,每块数据都有一定的**额外记号**来标记它们的去向.如果要发送的数据比较多,那么该系统调用需要**多次进行**,每次复制一定的数据大小,这个大小取决于网络数据包的大小以及内核缓冲区的承载能力.重复的系统调用体现在应用编程层面重复调用send函数.  
 3. 当数据写入**内核缓冲区**后,内核会通知**网卡控制器**前来读取数据,同时CPU转而处理其他进程.网卡控制器接到通知后,便根据网卡驱动信息得知对应内核缓冲区的地址,将要发送的数据复制到网卡的缓冲区.在以上一系列的数据复制中,数据始终按照连接两端设备的内部总线宽度来复制,也就是字节的整数倍,比如在32位总线的主机系统中,采用PCI-X总线接口的网卡一般使用32位总线宽度,那么从内核缓冲区到网卡缓冲区的数据复制过程中,任何时刻只能复制32位的比特信息.  
 4. 网卡缓冲区中的数据需要发送到线路中,同时释放缓冲区来获取更多要发送的数据.但是我们知道,**只有二进制的数字信号才可以在线路中传输**,所以这时候需要对数据进行**字节到位的转换**,这种转换不难想象,就是将数据的每个位按照顺序依次发出.  
 5. 发送时,网卡会使用内部特定的物理装置来生成可以传播的各种信号,比如在使用铜线线路时,网卡会根据"0"或"1"的变化产生不同的电信号;而使用光纤线路时,网卡会产生不同的光信号.  

##### 电磁波的速度  
 电信号与光信号进入线路后便都能够进行快速的传播,这个速度称为传播速度,它的单位是"m/s",即单位时间传播的距离.传播速度只与传播介质有关,铜线中电信号的传播速度大约为2.3*10<sup>8</sup>m/s,光纤中光信号的传播速度大约为2.0*10<sup>8</sup>m/s.所有的电磁波(包括可见光)在真空中的传播速度是常数,即是光速.不同的传播介质中信号的传播速度几乎等于常量.也就是说,不论数据发送装置以多快的发送速度让数据以信号的形式进入线路,在线路中信号的传播速度几乎可以认为是一样快的.根据电磁学的定律也可以说明这一点,观察者的参考坐标和发射光波的物体的速度不会影响被测量的光速.  
##### 数据发送速度  
 我们所讲的带宽是指数据的发送速度.如我们的百兆网卡,便是指网卡的最大发送速度为100Mbps,也就是网卡在1秒钟最多可以发出100Mb的数据.发送速度的大小包括以下几个因素:  
 
 + **信号传输频率**(即数据发送装置对二进制信号传送至线路的能力),以及另一端的数据接收装置对二进制信号的接收能力,同时也包括线路对传输频率的支持程度.信号的接收能力至关重要,如果接收能力跟不上,发送能力不可能提高,如数据链路层对于数据帧传输的控制机制完全是按照接收方的接收能力来确定发送速度的.  
 + **数据传播介质的并行度**,这里也可以称为"宽度",完全等价于计算机系统总线宽度的概念.在32位的计算机系统总线中,可以同一时刻传输32位数据.  
 
 要提高计算机总线的宽度,包括**提高总线频率和总线宽度**两种方法,比如使用64位总线系统或者使用主频更高的处理器等.这两种方法与以上数字通信带宽的两个决定因素完全相似.  
 事实上,数字网络通信相比于计算机内部数据传输而言,其传输距离要远远大于后者,所以他还隐藏着另一个因素,那就是信号在传播介质中的衰减.这与传播介质以及信号传播方式有着密切的关系.  

##### 为什么要限制带宽  
 在大多数的情况下,我们都将Web站点服务器托管在IDC,通过将其连接到某个交换机,从而接入互联网.
 这时候,我们的服务器拥有自己的IP地址,当站点用户通过互联网向这台服务器请求数据后,数据服务器流经交换机到达指定的路由器,
 这个过程需要**交换机的存储转发机制**,也就是交换机从连接服务器的端口接收数据,存储到交换机内部的高速缓冲区队列中,
 然后将其从连接路由器的端口发送出去,再经过路由器的转发,进入另一个网路,接下来一次重复这些过程,直到站点用户的PC.  
 在实际工作中,每处交换节点不可能只有你自己的服务器和你的用户在传输数据,而是在该处节点可能同时转发来自其他主机的数据,这时,包括你的数据在内的所有数据都汇集进入路由器的转发队列,路由器按照转发队列中的顺序来交错发送这些来自不同主机的数据,所以单从来自不同的主机的数据而言,其转发时的发送速度必定小于所有从路由器转发出去的数据的发送速度(即该交换节点的出口带宽).  
 因为带宽是有限的,而且互联网运营商也不会白白搭建网络,所以运营商在所有的基础交换节点上设置关卡,也就是限制数据从你的主机流入路由器转发队列的速度,而只要流入路由器转发队列的数据,都会按照路由器的出口带宽,流入其他网络.这种关卡设置实际上等于限制了你的主机发送数据的速度,那就是
 通过**限制交换机对于你主机的数据的接收速度**,来将你的发送速度牢牢控制在手,因为数据链路层的流量控制是通过控制接收方来实现的,对于交换机的限速设置,IDC的网管非常擅长.  
##### 共享还是独享  
 下面是两个被交换机限制了带宽的主机,它们都安装了MRTG,可以生成网卡流量报告单.      
 这里的Max Speed属性值,它是从**交换机接收端口获得的最大接收速度**,同时也是该主机的最大数据发送速度,但并不一定是此刻的实时发送速度,因为每时每刻发送速度都是传输协议根据接收方的接收能力不断调整的,比如通过数据链路层或者传输层的滑动窗口技术等流量控制机制进行速度的调整.  
 ![独享](https://github.com/LovingStar/basis/blob/master/website/IMAGE/%E7%8B%AC%E4%BA%AB.PNG)  
 
 如表2-1所示,这台主机使用了独享10M带宽,也就是10Mbit/s的数据发送速度,即1250.kBytes/s.如果路由器的出口带宽为100M,交换机的设置应该保证来自广播域内其他主机的数据发送速度总和不超过90Mbit/s,以保证该主机任何时刻都可以以10Mbit/s的速度发送数据,这才叫**独享带宽**,它独享的是路由器的一部分出口带宽,而不是交换机的带宽,因为交换机本身就是各个端口独享带宽而互不影响.  
 如果这台主机还为其他主机提供独享10M带宽的接入,并且路由器的出口带宽为100M,那么理论上总共只能接入10台主机,这样才能保证每台主机的实际带宽总是10M.假设宽带运营商为了多赚钱,给交换机上接入了20台主机,然后对每台交换机仍然都限制了10M带宽,这时
 从MRTG的Max Speed属性上看到的仍是1250.0kBytes/s,但是可以观察MRTG流量图或者使用Nmon实时流量监控来分析自己的10M带宽是否真的有所保证.  
 ![共享](https://github.com/LovingStar/basis/blob/master/website/IMAGE/%E5%85%B1%E4%BA%AB.PNG)  
 
 如表2-2所示,另一台主机使用了共享100M带宽,也就是100Mbit/s的数据发送速度.事实上很多的服务器托管都采用这种带宽方案,它的价格比较低,但这里的"共享"是指交换机不保证你的主机出口带宽能达到100M.假设交换机为50台主机同时提供共享100M带宽接入,事实上,每台主机的实际带宽要根据这些主机的总体通信量来决定,假设50台主机都要发送大量的数据(大文件下载),那么每台主机的发送速度大概控制在2Mbit/s左右;假设有49台主机在某时刻不发送数据,则剩余的1台主机此刻理论上可以达到100Mbit/s的速度,但是一般交换机对于共享带宽会限制最高峰,比如限制为10Mbit/s,那么即使某个时刻只有1台主机需要发送数据,交换机也会让它减速.  
 就不同地方的每个用户而言,当他们同时通过HTTP下载主机上的数据文件,单位时间内的接收到的数据一定比从服务器发出的数据少,这种从最终接收端体验到的速度我们一般称为"下载速度",**下载速度无论如何都小于发送速度**.  
### 2.3 响应时间  
 数据从服务器端到用户PC的传输过程中,流过若干个交换节点,并被不断地转发,然而用户看到的下载速度是一个关注结果的概念,而服务器以及各个交换节点的发送速度是一个关注过程的概念.  
##### 下载速度  
 下载速度是指单位时间里从服务器到达用户PC的数据量的多少,一般用字节数表示,故单位为:Bytes/s.计算下载速度的方法:用传输的数据字节数除以这些数据从服务器开始发送直到完全到达用户PC的时间.这段时间是
 从数据的第一个比特由服务器网卡进入线路开始,直到最后一个比特为进入用户PC的网卡为止.若此时间片很短,我们就叫计算结果为**实时下载速度**.  
 数据从服务器开始发送直到完全到达用户PC的这段时间,我们称为**响应时间**.  
 则:下载速度=数据量**字节数**/响应时间  
##### 如何计算响应时间  
 响应时间=发送时间+传播时间+处理时间  
 发送时间=数据量**比特数**/带宽+多个交换节点每次进行数据转发的时间  
 传播时间=传播距离/传播速度  
 处理时间:指数据在交换节点中为存储转发而进行一些必要的处理所花费的时间,其中重要的组成部分就是数据在缓冲区队列中排队所花费的时间.可见处理时间的多少取决于数据流经各交换节点所在网络的数据通信量,它往往是不可预测的.  
##### 一些习惯和约定  
 **比特的单位bit缩写为b**  
 **字节的单位Byte缩写为B**  
 所以1B=8b
 换算:1KB=2<sup>10</sup>B=1024B  
 1kb=10<sup>3</sup>b=1000b  
**结论**:下载速度受响应时间影响,而响应时间受各种非理想因素影响,有些因素应为用户需考虑,超出服务器方面所能解决的问题范围,而当服务器的接入在允许的情况下尽量使用独享带宽即可在一段程度上减少环境因素的影响.要搞清楚响应时间的消耗,必须根据实际情况,找出转发路径中是否存在一些较低带宽的节点,正是这些节点成为影响下载速度的瓶颈所在.  
### 2.4 互联互通  
 同样,在实际的互联网中,往往这些瓶颈出现在各互联网运营商之间的网络互联上,我们称为**互联互通**.  
 如果服务器和用户PC处于不同运营商的互联网中,那么不论是否在同一城市,数据都必须经过两个互联网运营商之间的互联节点,这个节点的带宽变成了令大家十分头疼的问题.  
 电信和网通两大互联网运营商之间的互联互通已实现.
 
 
 
 
 
 
 
 
 
 
