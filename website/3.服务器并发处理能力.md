 我们希望一台服务器在单位时间内能处理的请求越多越好,这也成了Web服务器的能力高低所在,它体现了我们常说的"服务器并发处理能力".本章所说的服务器,主要指用于提供HTTP服务的服务器,但是本章中所涉及的一些关于操作系统和内核的内容,并不限于Web服务器.  
## 3.1 吞吐率  
 我们用**吞吐率**来描述Web服务器的并发处理能力,即单位时间内Web服务器处理的请求数.  
 在一些常见的Web服务器软件中,通常会提供当前服务器运行状况以及吞吐率的查看方法,帮助我们对服务器吞吐率随时进行了解和监控,比如Apache的mod_status模块和Lighttpd的mod_status模块.  
#### 吞吐率和压力测试  
 相对于吞吐率,我们更加关心的是**最大吞吐率**,即单位时间内服务器能够处理的最大请求数.我们普遍采用"压力测试"的方法,通过模拟足够数目的并发用户数,分别持续发送一定的HTTP请求,并统计测试持续的总时间,计算出基于这种"压力"下的吞吐率,即为一个平均计算值.  
 
 另一方面,在Web服务器的实际工作中,其处理的HTTP请求通常包括对很多不同资源的请求,也就是请求不同的URL,比如这些请求有的是获取图片,有的是获取动态内容,显然服务器处理这些请求所花费的时间各不相同,而这些请求的不同时间的组成比例又是不确定的.但是我们在压力测试的时候若想要模拟这种不同请求交错地情况会给我们考察处理器并发能力带来难以想象的困难,我们知道在一个含有较多变量的数据模型中求解最优解是非常困难的,所以
 我们一般都简化模型,对同一个特定的有代表性的请求进行压力测试,然后根据需要,对多个请求的吞吐率按照比例计算加权平均值.  
 
 正是因为这些请求性质的不同,Web服务器并发能力强弱的关键便在于如何针对不同的请求性质来设计**最优并发策略**.  
#### 压力测试的前提条件  
 吞吐率的前提条件包括压力的描述和请求性质的描述,压力的描述包括**并发用户数**和**总请求数**,也就是模拟多少个用户同时向服务器发送多少个请求.请求性质则是对请求的URL所代表的**资源的描述**.  
#### 并发用户数  
 指:在某一时刻同时向服务器发送请求的用户总数.  
 对于压力测试中提到的每一个用户,连续发送请求实际上是指在发送一个请求并接收到响应数据后再发送下一个请求.故从微观层面上来看,
 当一个用户向服务器连续进行1000次请求的过程中,任何时刻服务器的网卡接收缓冲区中只有来自该用户的一个请求,而100个用户同时向服务器分别进行10次请求的过程中,
 服务器网卡接收缓冲区中最多有100个等待处理的请求,显然这时候服务器的压力更大.  
 
 **并发用户数**别名:**并发数**,**并发连接数**.  
 **服务器的最大并发数**,需要在服务器和用户双方期待的最大利益下进行权衡.  
 
 当**实际并发用户数**大于我们通过压力测试得出的服务器所能支持的最大并发数时,必然造成一部分用户需要等待超过预期的时间,影响了站点的服务质量.所以,得出最大并发数的意义,在于了解服务的承载能力,并且结合用户规模考虑适当的扩展方案.  
 在考虑实际用户规模的时候,我们要了解,用户访问Web站点通常使用的浏览器在下载一个网页以及网页中多个组件时,采用多线程的并发下载方式,但是对同一域名下URL的并发下载数是有最大限制的.虽然如此,一个真实的用户可能会给服务器带来两个或更多的并发用户数的压力.在书中为简化模型认为每个用户的并发下载数为1.  
 从Web服务器的角度来看,实际并发用户数也可以理解为Web服务器当前维护的代表不同用户的文件描述符总数,也就是**并发连接数**.  
 
 当实际并发用户数稍稍大于服务器所能维护的文件描述符上限时.如果请求的性质决定了处理每个请求花费的时间非常少,我们希望服务的最大并发数可以大于最大并发连接数.如果请求的性质决定了处理每个请求要花费相当长的时间,我们希望服务的最大并发用户数小于理论上的最大并发连接数.  
 
 **总结**:从某种意义上来说,Web服务器所做的工作的本质就是,争取以最快的速度将内核缓冲区中的用户请求数据一个不剩地都拿回来,然后进最大努力同时快速处理完这些请求,并将响应数据放到啮合维护的另一块用于发送数据的缓冲区中,接下来再尽快处理下一拨请求,并尽量让用户请求在内核缓冲区中不要等太久.  
#### 请求等待时间  
 **用户平均请求等待时间**主要用于衡量服务器在一定并发用户数的情况下,对于单个用户的服务质量;而**服务器平均请求处理时间**用于衡量服务器的整体服务质量,它其实就是吞吐率的倒数.  
#### 硬件环境  
 在以上压力测试中,我们普遍使用的Web服务器基本硬件配置如下:  
 CPU:Intel(R) Xeon(R) CPU 1.60GHz  
 内存:4GB  
 硬盘转速:15k/min  
#### 压力测试  
 有了这些前提,我们就可以用压力测试软件来计算吞吐率了,本书中大部分压力测试使用Apache附带的ab,它非常容易使用,完全可以模拟以上各种前提条件.另外,ab可以直接在Web服务器本地发起测试请求,这至关重要,因为我们希望测试的是服务器的处理时间,而不包括数据的网络传输时间以及用户PC本地的计算时间.  
 ab进行一切测试的本质都是基于HTTP,所以可以说它是对于Web服务器软件的黑盒性能测试,它获得的一切数据和计算结果,都可以通过HTTP来解释.  
 
 另有一些压力测试软件,包括LoadRunner,Jmeter等,则是不同程度上包含了服务器处理之外的时间,比如LoadRunner运行在用户PC上,可以录制浏览器的行为,这种测试的结果往往侧重于站在用户的角度.  
 
 我们对Web服务器的几个常见性能指标做了详细介绍,影响这些指标的因素,除去服务器的硬件配置,就是前面提到的**并发策略**.简单地说,并发策略的设计就是在服务器同时处理较多请求的时候,如何合理协调并充分利用CPU计算和I/O操作,使其在较大并发用户数的情况下提供较高的吞吐率.  
 并不存在一个对所有性质的请求都高效的并发策略,我们只能也只有了解并根据这些性质来选择最佳的并发策略,高性能Web站点才会离你更近一步.  
 
 
